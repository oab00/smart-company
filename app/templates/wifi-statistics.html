
{% extends "wifi-main.html" %}


{% block head %}

    <title>Statistics</title>

    <link rel="stylesheet" href="https://www.amcharts.com/lib/3/plugins/export/export.css" type="text/css" media="all" />

    <style>
        #amlinechart5 {
            background-color: white;
        }
    </style>

{% endblock %}


{% block content %}

    <div>
        <hr />
        <h1 style="display: inline-block;">Electricity Consumption</h1>
        <h4 style="color:grey; display: inline-block; margin-left: 10px;">(for main employee's Office only)</h4>
        <hr />
        <div id="amlinechart5"></div>
        <br /><br />
        <hr />
        <h1 style="display: inline-block;">Employee Performance</h1>
        <h4 style="color:grey; display: inline-block; margin-left: 10px;">(for main employee only)</h4>
        <hr />
        <div id="amlinechart1"></div>
    </div>

{% endblock %}

{% block scripts %}

    <script src="https://www.amcharts.com/lib/3/amcharts.js"></script>
    <script src="https://www.amcharts.com/lib/3/serial.js"></script>
    <script src="https://www.amcharts.com/lib/3/plugins/export/export.min.js"></script>
    <script src="https://www.amcharts.com/lib/3/themes/light.js"></script>

    <script type="text/javascript" charset="utf-8">
        function ab2str(buf) {
            return String.fromCharCode.apply(null, new Uint8Array(buf));
        }

        function parseHtmlEntities(str) {
            return str.replace(/&#([0-9]{1,3});/gi, function(match, numStr) {
                var num = parseInt(numStr, 10); // read num as normal number
                return String.fromCharCode(num);
            });
        }

        $(document).ready(function() {
            var socket = io.connect('http://' + document.domain + ':' + location.port);
            //var socket = io.connect('amqp://guest:guest@192.168.1.192:5672//');

            console.log('http://' + document.domain + ':' + location.port)

            socket.on('connect', function() {
                socket.emit('my event', {data: 'I\'m connected!'});
            });

            socket.on('refresh', () => {
                console.log('Refresh!')
                location.reload()
            });

            let consumptions = JSON.parse(parseHtmlEntities("{{ consumptions }}"));
            
            let data = Object.keys(consumptions).sort().map(date => {
                let hours = consumptions[date].hours;
                let kWh = consumptions[date].kWh;
                let price = consumptions[date].price;
                
                return {
                    "date": date,
                    "price": parseInt(kWh),
                    "prices": Number((price).toFixed(2)),
                    "hours": hours
                }
            });

            if ($('#amlinechart5').length) {
                var chart = AmCharts.makeChart("amlinechart5", {
                    "type": "serial",
                    "theme": "light",
                    "marginRight": 20,
                    "marginTop": 17,
                    "autoMarginOffset": 20,
                    "dataProvider": data,
                    "valueAxes": [{
                        "logarithmic": false,
                        "dashLength": 1,
                        "guides": [{
                            "dashLength": 6,
                            "inside": true,
                            "label": "average",
                            "lineAlpha": 1,
                            "value": 90.4
                        }],
                        "position": "left",
                        "title": "Kilowatt Hour (kWh)"
                    }],
                    "graphs": [{
                        "bullet": "round",
                        "id": "g1",
                        "bulletBorderAlpha": 1,
                        "bulletColor": "#FFFFFF",
                        "bulletSize": 7,
                        "lineThickness": 2,
                        "title": "Price",
                        "type": "smoothedLine",
                        "useLineColorForBulletBorder": true,
                        "valueField": "price",
                        "balloonText": "[[category]]<br><span style='font-size:14px;'>Consumption:  <b>[[value]] kWh</b></span>"
                                        + "<br>Time Spent in Office: <b>[[hours]] hours</b>",
                    },{
                        "bullet": "round",
                        "id": "g2",
                        "bulletBorderAlpha": 1,
                        "bulletColor": "#FFFFFF",
                        "bulletSize": 7,
                        "lineThickness": 2,
                        "title": "Prices",
                        "type": "smoothedLine",
                        "useLineColorForBulletBorder": true,
                        "valueField": "prices",
                        "balloonText": "<span style='font-size:14px;'>Cost:  <b>[[prices]] Riyal</b></span>"
                    }],
                    "chartScrollbar": {},
                    "chartCursor": {
                        "valueLineEnabled": true,
                        "valueLineBalloonEnabled": true,
                        "valueLineAlpha": 0.5,
                        "fullWidth": true,
                        "cursorAlpha": 0.05
                    },
                    "dataDateFormat": "YYYY-MM-DD",
                    "categoryField": "date",
                    "categoryAxis": {
                        "parseDates": true,
                        "title": "Daily Report for the Month of January"
                    },
                    "export": {
                        "enabled": false
                    }
                });

                /*chart.addListener("dataUpdated", zoomChart);

                function zoomChart() {
                    chart.zoomToDates(new Date(2012, 2, 2), new Date(2012, 2, 10));
                }*/

                let performances = JSON.parse(parseHtmlEntities("{{ performances }}"));
                
                data = Object.keys(performances).sort().map(date => {
                    //let hours = performances[date].hours;
                    let performance = performances[date].performance;
                    let meeting_hours = performances[date].meeting_hours;
                    let office_hours = performances[date].office_hours;
                    
                    return {
                        "date": date,
                        "performance":  performance * 100,
                        "meeting_hours": meeting_hours,
                        "office_hours": office_hours
                    }
                });

                if ($('#amlinechart1').length) {
                    var chart = AmCharts.makeChart("amlinechart1", {
                        "type": "serial",
                        "theme": "light",
                        "marginRight": 20,
                        "autoMarginOffset": 20,
                        "dataDateFormat": "YYYY-MM-DD HH:NN",
                        "dataProvider": data,
                        "valueAxes": [{
                            "axisAlpha": 0,
                            "guides": [{
                                "fillAlpha": 0.1,
                                "fillColor": "#c599ff",
                                "lineAlpha": 0,
                                "toValue": 120,
                                "value": 4
                            }],
                            "position": "left",
                            "tickLength": 0,
                            "title": "Performance Percentage (%)"
                        }],
                        "graphs": [{
                            "balloonText": "[[category]]<br><span style='font-size:14px;'>Performance:  <b>[[value]]%</span></b>"
                                            + "<br /> Time Spent in Meeting Room: <b>[[meeting_hours]] hours</b>"                
                                            + "<br /> Time Spent in Office: <b>[[office_hours]] hours</b>",
                            "bullet": "round",
                            "dashLength": 3,
                            "colorField": "color",
                            "valueField": "performance"
                        }],/*
                        "trendLines": [{
                            "finalDate": "2012-01-11 12",
                            "finalValue": 19,
                            "initialDate": "2012-01-02 12",
                            "initialValue": 10,
                            "lineColor": "#6e00ff"
                        }, {
                            "finalDate": "2012-01-22 12",
                            "finalValue": 10,
                            "initialDate": "2012-01-17 12",
                            "initialValue": 16,
                            "lineColor": "#6e00ff"
                        }],*/
                        "chartScrollbar": {
                            "scrollbarHeight": 2,
                            "offset": -1,
                            "backgroundAlpha": 0.2,
                            "backgroundColor": "#8816FD",
                            "selectedBackgroundColor": "#815FF5",
                            "selectedBackgroundAlpha": 1
                        },
                        "chartCursor": {
                            "fullWidth": true,
                            "valueLineEabled": true,
                            "valueLineBalloonEnabled": true,
                            "valueLineAlpha": 0.5,
                            "cursorAlpha": 0
                        },
                        "categoryField": "date",
                        "categoryAxis": {
                            "parseDates": true,
                            "axisAlpha": 0,
                            "gridAlpha": 0.1,
                            "minorGridAlpha": 0.1,
                            "minorGridEnabled": true,
                            "title": "Daily Report for the Month of January"
                        },
                        "export": {
                            "enabled": false
                        }
                    });
                    /*
                    chart.addListener("dataUpdated", zoomChart);

                    function zoomChart() {
                        chart.zoomToDates(new Date(2012, 0, 2), new Date(2012, 0, 13));
                    }*/
                }
            }
        });

        
    </script>

{% endblock %}